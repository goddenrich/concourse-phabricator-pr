#!/bin/bash
# vim: set ft=sh

set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

source $(dirname $0)/common.sh

PATH=/usr/local/bin:$PATH

payload=$TMPDIR/phabricator-resource-request

cat > $payload <&0


conduit_uri=$(jq -r '.source.uri // ""' < $payload)
ref=$(jq -r '.version.ref // ""' < $payload)
conduit_token=$(jq -r '.source.token // ""' < $payload)

token_arg=""
if [ -n "$conduit_token" ]; then
  token_arg='--conduit_token ${conduit_token}'
fi

get_latest_diff () {
  echo '{"limit":1}' | arc call-conduit --conduit-uri "$conduit_uri" differential.diff.search $token_arg
}

# TODO(rgodden) need to add the ref diff to end then invert the order
get_diffs_since_including () {
  search_diff=$1
  echo "{\"before\": $search_diff}" | arc call-conduit --conduit-uri "$conduit_uri" differential.diff.search $token_arg
}

format_for_concourse() {
  jq '.response.data[] | {ref: .id}'
}

if [ -n "$ref" ]; then
  get_diffs_since_including "$ref" | format_for_concourse >&3
else
  get_latest_diff | format_for_concourse >&3
fi
