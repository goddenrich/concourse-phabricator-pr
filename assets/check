#!/bin/bash
# vim: set ft=sh

set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

source $(dirname $0)/common.sh

PATH=/usr/local/bin:$PATH

payload=$TMPDIR/phabricator-resource-request

cat > $payload <&0


conduit_uri=$(jq -r '.source.uri // ""' < $payload)
diff=$(jq -r '.version.diff // ""' < $payload)
conduit_token=$(jq -r '.source.token // ""' < $payload)

# token_arg=""
# if [ -n "$conduit_token" ]; then
#   token_arg='--conduit_token ${conduit_token}'
# fi
#
# get_latest_diff () {
#   echo '{"limit":1}' | arc call-conduit --conduit-uri "$conduit_uri" differential.diff.search $token_arg
# }
#
# get_diffs_since_including () {
#   search_diff=$1
#   echo "{\"after\": $((search_diff-1)), \"order\": [\"-id\"]}" | arc call-conduit --conduit-uri "$conduit_uri" differential.diff.search $token_arg
# }
#
# format_for_concourse() {
#   jq '.response.data[] | {diff: .id}'
# }
#
# if [ -n "$diff" ]; then
#   get_diffs_since_including "$diff" | format_for_concourse >&3
# else
#   get_latest_diff | format_for_concourse >&3
# fi
$(dirname $0)/commands/check.py $1 >&3 < $payload
